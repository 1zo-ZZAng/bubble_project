<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUBBLE BUMUL</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" th:href="@{/css/login.css}">

</head>

<!--로그인 페이지-->

<body class="my-login-page">
    <section class="h-100">
        <div class="container h-100">
            <div class="row justify-content-md-center h-100">
                <div class="card-wrapper">
                    <div class="brand">
                        <img th:src="@{/images/iconlog.png}" alt="logo"> <!--버블버물 로고 올릴 것-->
                    </div>
                    <div class="card fat">
                        <div class="card-body">

                            <!--로그인-->
                            <h4 class="card-title">Login</h4>

                            <form th:action="@{/customer/loginaction.bubble}" method="post" id="form">
                                <!--아이디-->
                                <div class="form-group"> <!--input group 쓰면 태그 내에 있는 것들이 합쳐짐 근데 이건 input group이 아님-->
                                    <label for="id">Id

                                        <!--아이디 찾기-->
                                        <a th:href="@{/customer/findid.bubble}" class="float-right"> Forgot Id? </a>

                                    </label>
                                    <input type="text" id="id" name="id" class="form-control" required autofocus />
                                </div>
                                <!--비밀번호-->
                                <div class="form-group">
                                    <label for="password">Password
                                        <a th:href="@{/customer/findpw.bubble}" class="float-right"> Forgot
                                            Password? </a> <!--비밀번호 찾기 아직 안했음-->
                                    </label>
                                    <input type="password" id="password" name="password" class="form-control" autocomplete="off" required
                                        data-eye />
                                </div>

                                <div class="form-group" th:if="${param.error}">
                                    <p th:text="'아이디 또는 비밀번호가 틀렸습니다'" style="color: red;"></p>
                                </div>

                                <!--로그인 버튼-->
                                <div class="form-group m-0">
                                    <input type="button" value="Login" class="btn btn-primary btn-block"
                                        onclick="loginAction()" />
                                </div>
                                <div class="mt-3 mb-3 text-center">
                                    <span style="display:block;">Login with Social Account</span>
                                </div>
                                <div class="mt">
                                    <a id="kakao-login-btn" href="javascript:loginWithKakao()">
                                        <img th:src="@{/images/kakao-login.png}" alt="카카오 로그인 버튼" width="335" height="50">
                                    </a>
                                </div>

                                <!--회원가입-->
                                <div class="mt-4 text-center">
                                    Don't have an account? <a th:href="@{/customer/join.bubble}">Create One</a>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="footer">
                        Copyright &copy; 2023 &mdash; Bubble Bumul
                    </div>
                </div>
            </div>
        </div>
    </section>


    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.5/axios.min.js"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <script th:inline="javascript" type="text/javascript">
        function loginAction() {
            const id = document.getElementById("id");
            const password = document.getElementById("password");

            // 유효성 검사
            // 모든 항목이 입력되어 있어야함
            if (id.value.length <= 0) {
                alert('아이디를 입력하세요.');
                id.focus();
                return false; // 함수종료, 전송하지 않음
            }

            if (password.value.length <= 0) {
                alert('암호를 입력하세요.');
                password.focus();
                return false;
            }

            // 전송하기
            document.getElementById("form").submit();
        }

        // 소셜 로그인 (카카오)
        // 여우정
        // Kakao.init('f761a223ea6f6b6f19c7d7cb193bdc41');
        // 신애린
        Kakao.init('51de80643ee3e6de36c332711a96b13b');
        // 탁승은
        // ?

        function loginWithKakao() {
            Kakao.Auth.login({
                success: function (authObj) {
                    // console.log('authObj', authObj);
                    Kakao.API.request({
                        url: '/v2/user/me',
                        success: async function (response) {
                            // console.log('response', response);
                            // console.log('response', response.kakao_account.email);
                            // console.log('response', response.kakao_account.profile.nickname);

                            const id = "kakao" + response.id;
                            const email = response.kakao_account.email;
                            const nickname = response.kakao_account.profile.nickname;

                            // 성공시 이동할 페이지
                            const url = [[@{/api/customer/kakaologin.bubble}]];
                            const headers = { "Content-Type": "application/json" };
                            const body = { "email": email, "id": id };
                            const { data } = await axios.post(url, body, { headers: headers });

                            // console.log(data.ret);

                            if (data.ret == 1) { // 기존 회원이 카카오로 로그인 => home 화면으로
                                alert('로그인 성공');
                                location.href = "http://127.0.0.1:8282/bubble_bumul/customer/home.bubble";
                            }
                            else if (data.ret == -1) { // 카카오 계정 이메일이 기존 테이블에 있지만 이미 탈퇴한 회원인 경우
                                alert('이미 탈퇴된 계정입니다.');

                                if (Kakao.Auth.getAccessToken()) {
                                    Kakao.API.request({
                                        url: '/v1/user/unlink',
                                        success: function (response) {
                                            // console.log(response)
                                        },
                                        fail: function (error) {
                                            console.log(error)
                                        },
                                    });

                                    Kakao.Auth.setAccessToken(null);
                                }

                                location.href = "http://127.0.0.1:8282/bubble_bumul/customer/login.bubble";
                            }
                            else if (data.ret == 0) { // 기존 회원이 아님 => 추가 데이터를 받아서 회원가입
                                // console.log(id);
                                // console.log(email);
                                // console.log(nickname);

                                // 소셜 로그인용 회원가입 창으로~
                                const form = document.createElement("form");
                                form.setAttribute("action", [[@{/customer/kakaojoin.bubble}]]);
                                form.setAttribute("method", "post");
                                form.style.display = "none";

                                const input1 = document.createElement("input");
                                input1.setAttribute("type", "hidden");
                                input1.setAttribute("name", "id");
                                input1.setAttribute("value", id);

                                const input2 = document.createElement("input");
                                input2.setAttribute("type", "hidden");
                                input2.setAttribute("name", "email");
                                input2.setAttribute("value", email);

                                const input3 = document.createElement("input");
                                input3.setAttribute("type", "hidden");
                                input3.setAttribute("name", "name");
                                input3.setAttribute("value", nickname);

                                const input4 = document.createElement("input");
                                input4.type = "hidden";
                                input4.name = "_csrf";
                                input4.value = [[${ _csrf.token }]];

                                form.appendChild(input1);
                                form.appendChild(input2);
                                form.appendChild(input3);
                                form.appendChild(input4);

                                document.body.appendChild(form);
                                form.submit();

                                alert('로그인 성공');
                            }
						}
					})
		        },
                fail: function(err) {
                    alert(JSON.stringify(err));
                }
            });
        }
    </script>
</body>

</html>